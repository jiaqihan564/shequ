# 技术交流社区 - 宝塔面板部署指南

## 📋 部署前准备

### 1. 服务器要求
- 操作系统：Linux (推荐 CentOS 7+、Ubuntu 18.04+)
- 内存：至少 2GB
- 已安装宝塔面板
- 已安装 Nginx

### 2. 后端服务要求
- Go 后端服务已部署并运行（默认端口 8080）
- MySQL 数据库已配置

---

## 🚀 部署步骤

### 步骤 1：上传文件到服务器

#### 方法 1：使用宝塔面板的文件管理器
1. 登录宝塔面板
2. 点击左侧菜单 **文件**
3. 导航到 `/www/wwwroot/` 目录
4. 点击 **新建目录**，创建 `shequ-tech-community` 文件夹
5. 进入该文件夹，再创建 `dist` 和 `logs` 两个子文件夹
6. 将本地 `my-vue-app/dist` 目录下的**所有文件和文件夹**上传到服务器的 `/www/wwwroot/shequ-tech-community/dist/` 目录

#### 方法 2：使用 FTP/SFTP 工具（推荐）
使用 FileZilla 或 WinSCP：
```
本地路径：my-vue-app/dist/*
服务器路径：/www/wwwroot/shequ-tech-community/dist/
```

#### 方法 3：使用命令行（SCP）
```bash
# 打包 dist 目录
cd my-vue-app
tar -czf dist.tar.gz dist/

# 上传到服务器（替换 your_server_ip 为你的公网IP）
scp dist.tar.gz root@your_server_ip:/www/wwwroot/shequ-tech-community/

# 在服务器上解压
ssh root@your_server_ip
cd /www/wwwroot/shequ-tech-community/
tar -xzf dist.tar.gz
rm dist.tar.gz
```

### 步骤 2：创建日志目录

```bash
# SSH 连接到服务器后执行
mkdir -p /www/wwwroot/shequ-tech-community/logs
chmod 755 /www/wwwroot/shequ-tech-community/logs
```

或在宝塔面板的文件管理器中手动创建 `logs` 文件夹。

### 步骤 3：配置 Nginx

#### 方法 1：通过宝塔面板可视化配置（推荐）

1. **添加站点**
   - 登录宝塔面板
   - 点击左侧 **网站** → **添加站点**
   - 域名：填写你的公网 IP（例如：`123.45.67.89`）
   - 根目录：选择 `/www/wwwroot/shequ-tech-community/dist`
   - PHP 版本：选择 **纯静态**
   - 点击 **提交**

2. **修改站点配置**
   - 在网站列表中找到刚创建的站点
   - 点击右侧 **设置**
   - 选择 **配置文件** 标签
   - 将 `nginx.conf` 文件中的内容复制并粘贴进去
   - 注意修改以下配置项：
     ```nginx
     # 如果后端端口不是 8080，需要修改
     proxy_pass http://localhost:8080/api/;  # 改为实际后端端口
     proxy_pass http://localhost:8080/ws/;   # 改为实际后端端口
     ```
   - 点击 **保存**

3. **检查配置并重启 Nginx**
   - 点击左侧 **软件商店**
   - 找到 **Nginx**，点击 **设置**
   - 点击 **服务** 标签
   - 点击 **重载配置** 或 **重启**

#### 方法 2：手动配置（高级用户）

```bash
# 复制配置文件
cd /www/server/panel/vhost/nginx/
nano shequ-tech-community.conf

# 将 nginx.conf 的内容粘贴进去，保存后测试
nginx -t

# 如果显示 "test is successful"，则重启 nginx
systemctl restart nginx
# 或
service nginx restart
```

### 步骤 4：配置防火墙和安全组

1. **宝塔面板防火墙**
   - 点击左侧 **安全**
   - 确保 **80** 端口已开放
   - 如果需要 HTTPS，也开放 **443** 端口

2. **云服务器安全组**（阿里云/腾讯云等）
   - 登录云服务商控制台
   - 找到你的服务器实例
   - 配置安全组规则，开放：
     - 入站规则：TCP 80 端口（0.0.0.0/0）
     - 入站规则：TCP 443 端口（0.0.0.0/0）如果使用 HTTPS

### 步骤 5：验证部署

1. **访问前端**
   - 打开浏览器，访问：`http://你的公网IP`
   - 例如：`http://123.45.67.89`

2. **检查控制台**
   - 按 F12 打开浏览器开发者工具
   - 查看 Console 标签是否有错误
   - 查看 Network 标签，检查 API 请求是否正常

3. **检查 Nginx 日志**（如果有问题）
   ```bash
   # 查看访问日志
   tail -f /www/wwwroot/shequ-tech-community/logs/access.log
   
   # 查看错误日志
   tail -f /www/wwwroot/shequ-tech-community/logs/error.log
   ```

---

## 🔧 常见问题与解决方案

### 问题 1：访问 IP 显示 403 Forbidden

**原因：** 文件权限问题

**解决：**
```bash
cd /www/wwwroot/shequ-tech-community
chmod -R 755 dist/
chown -R www:www dist/
```

或在宝塔面板：文件 → 选中 dist 文件夹 → 权限 → 设置为 755，勾选"应用到子目录"

### 问题 2：页面空白或 JS/CSS 加载失败

**原因：** 静态资源路径配置问题

**解决：**
1. 检查 Nginx 配置中的 `root` 路径是否正确
2. 确保 `dist` 目录下有 `index.html` 和 `assets` 文件夹
3. 查看浏览器开发者工具 Network 标签，确认资源 URL

### 问题 3：API 请求失败（404 或 502）

**原因：** 后端服务未启动或代理配置错误

**解决：**
1. 检查后端服务是否正常运行：
   ```bash
   # 检查进程
   ps aux | grep shequ_gin
   
   # 检查端口
   netstat -tlnp | grep 8080
   ```

2. 确认 Nginx 配置中的 `proxy_pass` 地址和端口正确

3. 查看后端日志：
   ```bash
   cd /path/to/shequ_gin/log
   tail -f 2025-11-06/app.log
   ```

### 问题 4：路由刷新后 404

**原因：** Vue Router 的 history 模式需要服务器配置

**解决：** 确保 Nginx 配置中有以下配置（已包含在 nginx.conf 中）：
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

### 问题 5：WebSocket 连接失败

**原因：** WebSocket 代理配置问题

**解决：**
1. 确保 Nginx 配置包含 WebSocket 支持（已包含在 nginx.conf 中）
2. 检查防火墙是否允许 WebSocket 连接
3. 如果使用 HTTPS，WebSocket 也需要使用 WSS 协议

---

## 📊 性能优化建议

### 1. 启用 Gzip 压缩
配置文件中已包含 gzip 配置，确保已启用。

### 2. 配置浏览器缓存
已在配置中设置静态资源缓存 1 年。

### 3. 使用 CDN（可选）
如果用户访问量大，建议将静态资源上传到 CDN。

### 4. 启用 HTTP/2（可选）
如果使用 HTTPS，可以启用 HTTP/2 提升性能：
```nginx
listen 443 ssl http2;
```

---

## 🔄 更新部署

当有新版本需要更新时：

### 方法 1：通过宝塔面板
1. 备份当前 dist 目录（重命名为 dist_backup）
2. 上传新的 dist 文件
3. 测试无误后删除备份

### 方法 2：使用命令行
```bash
# 备份
cd /www/wwwroot/shequ-tech-community
mv dist dist_backup_$(date +%Y%m%d_%H%M%S)

# 上传并解压新版本
tar -xzf dist.tar.gz

# 重启 nginx（如果需要）
nginx -s reload
```

---

## 📝 后端配置说明

确保后端 Go 服务的配置正确：

### 1. CORS 配置
后端需要允许前端 IP 访问：
```yaml
# config.yaml
cors:
  allowed_origins:
    - "http://你的公网IP"
    - "http://localhost:5173"  # 开发环境
```

### 2. 后端服务启动
```bash
cd /path/to/shequ_gin
nohup ./shequ_gin > output.log 2>&1 &

# 或使用 systemd 管理（推荐）
systemctl start shequ_gin
systemctl enable shequ_gin
```

---

## 🛡️ 安全建议

1. **定期更新系统和软件**
   ```bash
   yum update -y  # CentOS
   apt update && apt upgrade -y  # Ubuntu
   ```

2. **修改默认 SSH 端口**
   - 在宝塔面板：安全 → SSH 端口

3. **启用宝塔防火墙**
   - 只开放必要的端口（80、443、SSH）

4. **定期备份**
   - 在宝塔面板设置自动备份
   - 备份网站文件和数据库

5. **配置 fail2ban**（防暴力破解）
   - 在宝塔软件商店安装

---

## 📞 技术支持

如遇到问题，请检查：
1. Nginx 错误日志：`/www/wwwroot/shequ-tech-community/logs/error.log`
2. Nginx 访问日志：`/www/wwwroot/shequ-tech-community/logs/access.log`
3. 宝塔系统日志：面板 → 日志
4. 后端日志：`shequ_gin/log/`

---

## ✅ 部署检查清单

- [ ] dist 文件已上传到 `/www/wwwroot/shequ-tech-community/dist/`
- [ ] logs 目录已创建并设置权限
- [ ] Nginx 配置已添加并修改（后端端口等）
- [ ] Nginx 配置测试通过 (`nginx -t`)
- [ ] Nginx 已重启
- [ ] 防火墙端口已开放（80、443）
- [ ] 安全组规则已配置
- [ ] 后端服务正常运行
- [ ] 可以通过公网 IP 访问网站
- [ ] API 请求正常
- [ ] WebSocket 连接正常（如果使用）

---

祝部署顺利！🎉

