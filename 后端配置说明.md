# 后端配置说明

## 📌 重要配置项

### 1. 后端服务端口

当前后端端口：**3001**（在 `shequ_gin/config.yaml` 中配置）

```yaml
server:
  port: "3001"
```

**Nginx 配置已自动设置为 3001 端口**，无需修改。

---

### 2. CORS 配置（重要！）

#### 当前配置
```yaml
cors:
  allow_origins: ["*"]  # 允许所有来源
  allow_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
  allow_headers: ["Origin", "Content-Type", "Content-Length", "Accept-Encoding", "X-CSRF-Token", "Authorization", "X-Request-ID"]
  allow_credentials: true
```

#### 生产环境建议修改

为了安全，部署到生产环境后，建议将 `allow_origins` 改为你的公网 IP：

```yaml
cors:
  allow_origins: 
    - "http://你的公网IP"          # 例如: http://123.45.67.89
    - "http://localhost:5173"      # 保留用于本地开发
  allow_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
  allow_headers: ["Origin", "Content-Type", "Content-Length", "Accept-Encoding", "X-CSRF-Token", "Authorization", "X-Request-ID"]
  allow_credentials: true
```

**如何修改：**

1. SSH 连接到服务器
2. 编辑配置文件：
   ```bash
   cd /path/to/shequ_gin
   nano config.yaml
   # 或使用 vim
   vim config.yaml
   ```
3. 找到 `cors` 部分，修改 `allow_origins`
4. 保存并重启后端服务：
   ```bash
   # 如果使用 systemd
   systemctl restart shequ_gin
   
   # 或者杀死进程重新启动
   pkill shequ_gin
   nohup ./shequ_gin > output.log 2>&1 &
   ```

---

### 3. 数据库配置

确保数据库连接信息正确：

```yaml
database:
  host: "127.0.0.1"
  port: "3306"
  username: "root"
  password: "root"          # 修改为你的数据库密码
  database: "hub"           # 确保数据库已创建
  charset: "utf8mb4"
```

**初始化数据库：**
```bash
cd shequ_gin/sql
mysql -u root -p < user_tables.sql
mysql -u root -p < article_tables.sql
mysql -u root -p < chat_tables.sql
mysql -u root -p < code_tables.sql
mysql -u root -p < resource_tables.sql
# ... 其他 SQL 文件
```

---

### 4. MinIO 对象存储配置

用于存储用户头像和资源文件：

```yaml
minio:
  endpoint: "127.0.0.1:9000"
  access_key_id: "minioadmin"      # 修改为你的 MinIO 密钥
  secret_access_key: "minioadmin"  # 修改为你的 MinIO 密钥
  use_ssl: false
  bucket: "community-assets"

assets:
  public_base_url: "http://127.0.0.1:9000/community-assets"  # 如果外网访问，改为公网IP

resources_storage:
  bucket: "community-resources"
  public_base_url: "http://127.0.0.1:9000/community-resources"  # 如果外网访问，改为公网IP
```

**MinIO 安装和配置：**

1. 安装 MinIO（宝塔面板）：
   - 软件商店 → 搜索 "MinIO" → 安装

2. 或使用 Docker：
   ```bash
   docker run -d \
     -p 9000:9000 \
     -p 9001:9001 \
     --name minio \
     -e "MINIO_ROOT_USER=minioadmin" \
     -e "MINIO_ROOT_PASSWORD=minioadmin" \
     -v /data/minio:/data \
     minio/minio server /data --console-address ":9001"
   ```

3. 创建 Bucket：
   - 访问 `http://服务器IP:9001`
   - 登录后创建两个 bucket：
     - `community-assets`
     - `community-resources`
   - 设置为 Public 访问

---

### 5. JWT 密钥配置（重要！）

**生产环境务必修改 JWT 密钥：**

```yaml
jwt:
  secret_key: "你的随机密钥"  # 使用强随机字符串
  expire_hours: 24
  issuer: "community-api"
```

**生成随机密钥：**
```bash
# Linux/Mac
openssl rand -base64 48

# 或使用 Python
python3 -c "import secrets; print(secrets.token_urlsafe(48))"
```

---

### 6. 安全配置

#### 修改管理员默认密码

```yaml
admin:
  usernames:
    - "admin"
  default_password: "admin123"  # 首次启动后请立即修改
  email_suffix: "@admin.local"
```

**首次部署后立即：**
1. 登录系统（用户名：`admin`，密码：`admin123`）
2. 进入个人中心修改密码
3. 或直接修改配置文件中的 `default_password`

#### 限流配置

根据实际需求调整：

```yaml
rate_limiter:
  global:
    capacity: 100
    requests_per_minute: 100  # 每分钟 100 次请求
  login:
    capacity: 5
    requests_per_minute: 5    # 登录限流：每分钟 5 次
  register:
    capacity: 10
    requests_per_minute: 10   # 注册限流：每分钟 10 次
```

---

### 7. 日志配置

```yaml
log:
  level: "info"          # 生产环境建议使用 info 或 warn
  format: "json"         # json 格式便于日志收集
  output: "file"
  file_path: "log/app.log"
  max_size: 100          # 单个日志文件最大 100MB
  max_backups: 3         # 保留 3 个备份
  max_age: 28            # 保留 28 天
```

**查看日志：**
```bash
cd /path/to/shequ_gin/log
tail -f $(date +%Y-%m-%d)/app.log
```

---

### 8. 代码执行器配置

使用 Piston API 执行代码：

```yaml
code_executor:
  piston_api_url: "https://emkc.org/api/v2/piston"
  timeout: 10
  max_memory_mb: 128
  rate_limit: 10  # 每分钟执行次数
```

**可选：自建 Piston 服务**
```bash
docker run -d \
  -p 2000:2000 \
  --name piston \
  ghcr.io/engineer-man/piston
```

然后修改配置：
```yaml
code_executor:
  piston_api_url: "http://localhost:2000"
```

---

## 🚀 启动后端服务

### 方法 1：直接运行

```bash
cd /path/to/shequ_gin
./shequ_gin
```

### 方法 2：后台运行

```bash
cd /path/to/shequ_gin
nohup ./shequ_gin > output.log 2>&1 &
```

### 方法 3：使用 systemd（推荐）

创建服务文件：
```bash
sudo nano /etc/systemd/system/shequ_gin.service
```

内容：
```ini
[Unit]
Description=Shequ Tech Community Backend
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/path/to/shequ_gin
ExecStart=/path/to/shequ_gin/shequ_gin
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl start shequ_gin
sudo systemctl enable shequ_gin
sudo systemctl status shequ_gin
```

---

## 🔍 检查服务状态

### 1. 检查进程
```bash
ps aux | grep shequ_gin
```

### 2. 检查端口
```bash
netstat -tlnp | grep 3001
# 或
ss -tlnp | grep 3001
```

### 3. 测试 API
```bash
curl http://localhost:3001/api/health
```

应该返回：
```json
{
  "status": "ok",
  "timestamp": "2024-11-06T..."
}
```

### 4. 查看日志
```bash
cd /path/to/shequ_gin/log
tail -f $(date +%Y-%m-%d)/app.log
```

---

## 📋 部署检查清单

- [ ] 数据库已创建并初始化（hub）
- [ ] MinIO 已安装并创建 bucket
- [ ] config.yaml 中的数据库密码已修改
- [ ] JWT secret_key 已修改为强随机字符串
- [ ] CORS allow_origins 已修改为公网 IP
- [ ] 管理员默认密码已修改
- [ ] MinIO public_base_url 已修改（如需外网访问）
- [ ] 后端服务正常启动（端口 3001）
- [ ] 健康检查 API 返回正常
- [ ] 防火墙已开放 3001 端口（如果前后端分离部署）

---

## 🛡️ 生产环境安全建议

1. **修改所有默认密码**
   - 数据库 root 密码
   - MinIO 访问密钥
   - 管理员默认密码

2. **限制数据库访问**
   ```yaml
   database:
     host: "127.0.0.1"  # 不要使用 0.0.0.0
   ```

3. **使用环境变量存储敏感信息**
   ```bash
   export DB_PASSWORD="your_db_password"
   export JWT_SECRET="your_jwt_secret"
   ```

4. **定期备份数据库**
   ```bash
   mysqldump -u root -p hub > backup_$(date +%Y%m%d).sql
   ```

5. **启用 HTTPS**（需要域名）
   - 在宝塔面板申请免费 SSL 证书
   - 修改配置文件中的 URL 为 https://

6. **监控日志**
   - 定期检查错误日志
   - 设置日志告警

---

## 📞 问题排查

### 问题 1：后端无法连接数据库

**检查：**
```bash
mysql -h 127.0.0.1 -u root -p hub
```

**解决：**
- 确认数据库服务运行中
- 检查用户名密码
- 确认数据库已创建

### 问题 2：MinIO 连接失败

**检查：**
```bash
curl http://127.0.0.1:9000/minio/health/live
```

**解决：**
- 启动 MinIO 服务
- 检查防火墙端口 9000

### 问题 3：CORS 错误

**浏览器显示：** `Access to XMLHttpRequest ... has been blocked by CORS policy`

**解决：**
- 检查 config.yaml 中的 allow_origins
- 确保包含前端的访问地址
- 重启后端服务

---

**配置完成后，记得重启后端服务使配置生效！**

